name: Run Tests and Lint

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        id: install_deps
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest

      - name: Lint with Flake8
        id: lint
        run: |
          source venv/bin/activate
          flake8 . --count --show-source --statistics

      - name: Run tests
        id: tests
        run: |
          source venv/bin/activate
          pytest

      # Отправка уведомления в Telegram при провале
      - name: Send Telegram message on failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }} # Получатель из секрета GitHub
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }} # Токен бота из секрета GitHub
          message: |
            Тесты или линтинг провалены!
            Репозиторий: ${{ github.repository }}
            Событие: ${{ github.event_name }}
            Коммит: ${{ github.sha }}
